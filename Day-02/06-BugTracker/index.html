<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bug Tracker</title>
    <style>
        .closed {
            color : red;
            text-decoration: line-through;
            font-style: italic;
            font-weight: bold;
        }
        .stats{
            font-size: 18pt;
            font-weight: bold;
        }
        div{
            margin-bottom: 10px;
        }
        li{
            border: 1px solid grey;
            background-color: #e7e7e7;
            padding: 5px;
            border-radius: 4px;
            margin: 5px;
        }
        li span.name{
            font-size: 18pt;
            cursor: pointer;
        }
        li span.date{
            display: block;
            font-style: italic;
            font-size: small;
        }
        ol{
            list-style: none;
            width: 60%;
        }
    </style>
    <!--
    Use Cases
    ==========
    1. List the bugs - done
    2. Add a new bug - done
    3. Toggle the completion status of a bug - done
    4. Remove closed bugs - done
    5. Search for bug - done
    6. Sort the bug - done
    7. Improvise the bug display - done
    8. Display the 'createdAt' for all the bugs
    9. Persist the bugs in 'localStorage'
    10. Persist the bugs in the server
    11. Categorize the bugs
    12. Allow the user to navigate by category
    -->
    <script src="angular.min.js"></script>
    <script>

        var bugTrackerApp = angular.module("bugTrackerApp", []);
        /*bugTrackerApp.value("Bug", function Bug(name){
            this.name = name;
            this.isClosed = false;
            this.toggle = function(){
                this.isClosed = !this.isClosed;
            }
        });*/

        bugTrackerApp.factory("Bug", function(){
            function Bug(defaults){
                this.name = defaults.name || '';
                this.isClosed = defaults.isClosed || false;
                this.createdAt = defaults.createdAt || new Date();
            }
            Bug.prototype.toggle = function(){
                this.isClosed = !this.isClosed;
            };
            return Bug;
        });

        bugTrackerApp.factory("bugsCollection", function(Bug){
            var list = [
                new Bug({ name : "User authentication failure"}),
                new Bug({ name : "Server communication erratic", isCompleted : true}),
                new Bug({ name : "Control alignment not right"}),
            ];
            function add(name){
                var newBug = new Bug({name : name});
                list.push(newBug);
            }
            function removeClosed(){
                for(var i=list.length -1; i>= 0; i--)
                    if (list[i].isClosed)
                        list.splice(i,1);
            }
            function toggle(bug){
                bug.toggle();
            }
            return {
                list : list,
                add : add,
                toggle : toggle,
                removeClosed : removeClosed,
            }
        });

        bugTrackerApp.controller("bugsController", function($scope, bugsCollection){
            $scope.newBugName = '';
            $scope.bugs = bugsCollection;
            $scope.addNew = function(){
                bugsCollection.add($scope.newBugName);
                $scope.newBugName = '';
            };

        });
        bugTrackerApp.value("defaultTrimLength", 30);
        bugTrackerApp.filter('trimText', function(defaultTrimLength){
            return function(data,trimLength){
                trimLength = trimLength || defaultTrimLength;
                return data.length <= trimLength ? data : data.substr(0,trimLength)+'...';
            }
        });

        bugTrackerApp.filter("toClosedCount", function(){
            return function(bugs){
                return bugs.reduce(function(result, bug){
                    return bug.isClosed ? ++result : result;
                },0);
            }
        });

    </script>
</head>
<body ng-app="bugTrackerApp">
    <h1>Bug Tracker</h1>
    <hr>
    <section class="content" ng-controller="bugsController">
        <div class="stats">
            <span class="closed">{{bugs.list | toClosedCount}}</span>
            /
            <span>{{bugs.list.length}}</span>
        </div>
        <div class="sort">
            <label for="">Order By :</label>
            <input type="text" ng-model="sortBy">
            <label for="">Descending ? :</label>
            <input type="checkbox" ng-model="sortOrder">
        </div>
        <div class="filter">
            <label for="">Search :</label>
            <input type="text" ng-model='searchBug.name'>
            <label for="">Closed?</label>
            <input type="checkbox" ng-model="searchBug.isClosed">
            <input type="button" value="Show All" ng-click="searchBug.isClosed=undefined">
        </div>
        <div class="edit">
            <label for="">Bug :</label>
            <input type="text" ng-model="newBugName">
            <input type="button" value="Add New" ng-click="addNew()">
            <input type="button" value="Remove Closed" ng-click="bugs.removeClosed()">
        </div>
        <div class="list">
            <ol>
                <li
                    ng-repeat="bug in bugs.list | orderBy:sortBy:sortOrder | filter:searchBug">
                    <span class="name" ng-click="bugs.toggle(bug)"
                    ng-class="{closed : bug.isClosed}">
                         {{bug.name | trimText}}
                    </span>
                    <span class="date">
                        {{bug.createdAt | date}}
                    </span>
                </li>
            </ol>
        </div>
    </section>
</body>
</html>
